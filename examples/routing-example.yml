# Routing Example Configuration
# This configuration demonstrates intelligent request routing with Fly-Replay
# for multi-region deployments and deployment stamps pattern

server:
  listen: 3000
  hostname: localhost

  # Static file configuration
  static:
    public_dir: public
    cache_control:
      overrides:
        - path: /assets/
          max_age: 0

# Maintenance page configuration
maintenance:
  enabled: false  # Set to true to enable maintenance mode (all requests get 503 page)
  page: /503.html

# Intelligent routing with Fly-Replay
routes:
  fly:
    replay:
      # Route admin panel to primary region
      - pattern: ^/admin(/.*)?$
        replacement: $1
        region: iad     # Route to IAD (Virginia) region
        flag: last

      # Route specific tenants to their home regions
      - pattern: ^/tenant/europe(/.*)?$
        replacement: $1
        region: ams     # Route to Amsterdam region
        flag: last

      - pattern: ^/tenant/asia(/.*)?$
        replacement: $1
        region: nrt     # Route to Tokyo region
        flag: last

      # Route to specific machine for debugging
      - pattern: ^/debug/machine/(.+?)/(.*)$
        replacement: $2
        instance: $1    # Route to specific machine ID
        flag: last

      # Route to any instance of a specific app
      - pattern: ^/app/(.+?)/(.*)$
        replacement: $2
        app: $1        # Route to any instance of the app
        flag: last

  # Rewrite rules for other routing
  rewrite_rules:
    # Maintenance mode for specific paths
    - pattern: ^/maintenance(/.*)?$
      replacement: /503.html
      status: 503               # Return 503 Service Unavailable
      flag: last

# Multi-tenant application configuration
applications:
  framework: rails
  runtime_exec: bundle
  server_exec: exec
  server_args: ["puma", "-p", "{{port}}"]

  pools:
    max_size: 10
    timeout: 5m
    start_port: 4000

  tenants:
    # US East tenant
    - name: us-east
      root: /app/tenants/us-east
      env:
        RAILS_ENV: production
        DATABASE_URL: sqlite3:db/us-east.sqlite3
        REGION: us-east

    # Europe tenant
    - name: europe
      root: /app/tenants/europe
      env:
        RAILS_ENV: production
        DATABASE_URL: sqlite3:db/europe.sqlite3
        REGION: europe

    # Asia tenant
    - name: asia
      root: /app/tenants/asia
      env:
        RAILS_ENV: production
        DATABASE_URL: sqlite3:db/asia.sqlite3
        REGION: asia